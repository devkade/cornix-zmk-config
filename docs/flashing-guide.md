# Cornix 키보드 플래싱 가이드

이 문서는 Cornix 키보드에 ZMK 펌웨어를 플래싱하는 방법을 설명합니다.

## 🔌 플래싱 준비사항

### 필수 준비물
- **USB-C 케이블** - 각 키보드 반쪽을 컴퓨터에 연결
- **생성된 펌웨어 파일들**:
  - `firmware/cornix_left.uf2` - 왼쪽 키보드 펌웨어
  - `firmware/cornix_right.uf2` - 오른쪽 키보드 펌웨어
  - `firmware/reset.uf2` - 설정 초기화 펌웨어

### 빌드 방법
펌웨어가 없는 경우 다음 명령어로 빌드:

```bash
# Python 가상 환경 활성화
source .venv/bin/activate

# 각 타겟별 빌드
west build -p -s zmk/app -b cornix_left -- -DZMK_CONFIG=$(pwd)/config/
cp build/zephyr/zmk.uf2 firmware/cornix_left.uf2

west build -p -s zmk/app -b cornix_right -- -DZMK_CONFIG=$(pwd)/config/
cp build/zephyr/zmk.uf2 firmware/cornix_right.uf2

west build -p -s zmk/app -b cornix_right -- -DZMK_CONFIG=$(pwd)/config/ -DSHIELD=settings_reset
cp build/zephyr/zmk.uf2 firmware/reset.uf2
```

## 📋 플래싱 순서 (중요!)

### 1단계: 리셋 펌웨어 플래싱 (양쪽 모두)

먼저 기존 설정을 초기화합니다:

#### 왼쪽 키보드
1. 왼쪽 키보드를 USB-C 케이블로 컴퓨터에 연결
2. 키보드 뒷면의 리셋 버튼을 **2번 빠르게** 누르기
3. 키보드가 USB 드라이브로 인식됨 (보통 `NICENANO` 또는 `CORNIX` 이름)
4. `firmware/reset.uf2` 파일을 드래그 앤 드롭으로 복사
5. 키보드가 자동으로 재부팅될 때까지 대기

#### 오른쪽 키보드  
6. 오른쪽 키보드를 USB-C 케이블로 컴퓨터에 연결
7. 키보드 뒷면의 리셋 버튼을 **2번 빠르게** 누르기
8. 키보드가 USB 드라이브로 인식됨
9. `firmware/reset.uf2` 파일을 드래그 앤 드롭으로 복사
10. 키보드가 자동으로 재부팅될 때까지 대기

### 2단계: 실제 펌웨어 플래싱

#### 왼쪽 키보드
1. 왼쪽 키보드를 USB-C로 연결
2. 리셋 버튼을 **2번 빠르게** 누르기
3. `firmware/cornix_left.uf2` 파일을 드래그 앤 드롭으로 복사
4. 자동 재부팅 대기

#### 오른쪽 키보드
5. 오른쪽 키보드를 USB-C로 연결
6. 리셋 버튼을 **2번 빠르게** 누르기  
7. `firmware/cornix_right.uf2` 파일을 드래그 앤 드롭으로 복사
8. 자동 재부팅 대기

### 3단계: 페어링 및 테스트

1. **양쪽 키보드 동시 리셋**: 플래싱 완료 후 양쪽 모두 리셋 버튼 한 번씩 누르기
2. **USB 연결 테스트**: 먼저 USB로 키보드가 정상 작동하는지 확인
3. **블루투스 페어링**: 
   - 키보드에서 블루투스 프로필 선택 (`Lower + 1~5` 키)
   - 모바일 기기에서 먼저 테스트 (PC보다 연결이 안정적)
   - 컴퓨터 블루투스 설정에서 "Cornix" 또는 "ZMK Keyboard" 검색하여 연결

## ⚠️ 플래싱 주의사항

### 리셋 버튼 사용법
- **위치**: Cornix 키보드 뒷면의 작은 버튼
- **방법**: **2번 빠르게** 눌러야 부트로더 모드 진입
- **타이밍**: 너무 느리면 일반 리셋, 너무 빠르면 인식 안됨

### 플래싱 중 주의사항
- **케이블 분리 금지**: 플래싱 중 USB 케이블을 뽑으면 키보드 손상 가능
- **완료 대기**: 파일 복사 완료 후 자동 재부팅이 끝날 때까지 기다리기
- **순차 플래싱**: 양쪽 키보드를 동시에 플래싱하지 말고 하나씩 순서대로
- **안전한 분리**: 플래싱 완료 후 "USB 장치 안전하게 분리" 실행

### 플래싱 순서가 중요한 이유
1. **리셋 먼저**: 기존 설정이 새 펌웨어와 충돌하는 것을 방지
2. **양쪽 모두 리셋**: 분할 키보드는 양쪽이 동기화되어야 함
3. **실제 펌웨어 마지막**: 깨끗한 상태에서 새 펌웨어 적용

## 🔍 문제 해결

### 키보드가 USB 드라이브로 인식되지 않음
1. **다른 USB 케이블 사용**: 데이터 전송 지원하는 케이블 확인
2. **리셋 버튼 재시도**: 2번 연속 누르기를 더 빠르게/느리게 시도
3. **USB 포트 변경**: 다른 USB 포트 사용
4. **컴퓨터 재시작**: USB 드라이버 문제일 수 있음

### 키 입력이 작동하지 않음
1. **양쪽 동시 리셋**: 양쪽 키보드 모두 리셋 버튼 한 번씩 누르기
2. **USB 우선 테스트**: 블루투스 전에 USB 연결로 테스트
3. **키맵 설정 확인**: `config/cornix.keymap` 파일 내용 검토
4. **완전 초기화**: reset.uf2를 다시 플래싱 후 처음부터 재시도

### 블루투스 연결 문제
1. **기존 페어링 삭제**: 컴퓨터/모바일에서 기존 "Cornix" 연결 삭제
2. **모바일 우선 테스트**: 스마트폰으로 먼저 연결 테스트
3. **블루투스 프로필 초기화**: 
   - `Lower + BT_CLR` 키 조합으로 모든 블루투스 설정 삭제
   - 또는 키맵에서 `&bt BT_CLR` 기능 실행
4. **재부팅 후 재시도**: 키보드와 연결할 기기 모두 재부팅

### 한쪽 키보드만 작동함
1. **양쪽 모두 새 펌웨어**: 두 키보드 모두 같은 버전의 펌웨어 사용 확인
2. **동시 리셋**: 플래싱 후 양쪽 키보드 동시에 리셋
3. **TRRS 케이블 확인**: 키보드 간 연결 케이블 상태 점검
4. **중앙 역할 확인**: 왼쪽 키보드가 중앙(Central) 역할 수행하는지 확인

## 📱 블루투스 프로필 관리

### 기본 키맵의 블루투스 제어
기본 키맵(`config/cornix.keymap`)에서 다음 키 조합 사용:

- **Lower + 1**: BT Profile 0 (첫 번째 기기)
- **Lower + 2**: BT Profile 1 (두 번째 기기)  
- **Lower + 3**: BT Profile 2 (세 번째 기기)
- **Lower + 4**: BT Profile 3 (네 번째 기기)
- **Lower + 5**: BT Profile 4 (다섯 번째 기기)
- **Lower + BT_CLR**: 모든 블루투스 프로필 삭제

### 블루투스 기능
- **다중 기기 지원**: 최대 5개 기기까지 페어링 가능
- **빠른 전환**: 키 조합으로 기기 간 즉시 전환
- **자동 재연결**: 기기가 범위 내에 있으면 자동으로 연결 시도

### 연결 우선순위
1. **USB 연결**: USB 케이블 연결 시 USB가 우선
2. **마지막 활성**: 가장 최근에 사용한 블루투스 기기
3. **프로필 순서**: 낮은 번호 프로필이 높은 우선순위

## 🔄 업데이트 및 유지보수

### 펌웨어 업데이트
새로운 키맵이나 설정 변경 시:
1. 새로 빌드한 펌웨어로 **2단계부터** 실행 (리셋 불필요)
2. 큰 변경사항이 있을 때만 1단계부터 전체 실행

### 백업 권장사항
- **설정 파일 백업**: `config/` 디렉토리 전체 백업
- **작동하는 펌웨어 보관**: 안정적으로 작동하는 `.uf2` 파일들 별도 저장
- **키맵 문서화**: 커스텀 키맵의 경우 레이아웃 문서 작성

### 정기 점검
- **배터리 상태**: 배터리 잔량 정기 확인
- **펌웨어 업데이트**: ZMK 최신 버전 확인 및 업데이트
- **연결 안정성**: 블루투스 연결 품질 및 지연시간 모니터링